#!/bin/sh
# Auto generate sip/iax2 users for Asterisk.

TMP_SIP_CLIENT=/var/tmp_sip_client
TMP_IAX2_CLIENT=/var/tmp_iax2_client
rm /etc/asterisk/softphone.sip.conf

[ -f $TMP_SIP_CLIENT ] && rm $TMP_SIP_CLIENT
[ -f $TMP_IAX2_CLIENT ] && rm $TMP_IAX2_CLIENT

touch $TMP_SIP_CLIENT
touch $TMP_IAX2_CLIENT

set_softphone_client(){
	ID=$1
	USER=`uci get voip.$ID.username`
	NUMBER=`uci get voip.$ID.number`
	PASSWORD=`uci get voip.$ID.password`

----------------------------------------------
cat >> $TMP_SIP_CLIENT << EOF
[$NUMBER](softph)
username=$USER
secret=$PASSWORD

EOF
# --------------------------------------------

----------------------------------------------
cat >> $TMP_IAX2_CLIENT << EOF
[$NUMBER](softph)
secret=$PASSWORD

EOF
# --------------------------------------------

}

# Distribute User 
# Add clients to softphone.sip.conf file 
USER_LIST=`uci show voip | grep '=clients' | awk '{gsub(/voip./,"")} {gsub(/=clients/,"")} {print $1}'`
ANALOG_NUMBER=""
for client in $USER_LIST; do
	# check if its type is clients
	if [ `uci get voip.$client` == "clients" ] && [ ! -z `uci get voip.$client.number` ] ;then
		if [ `uci get voip.$client.ext_type` == "softphone" ]; then
			set_softphone_client $client

		elif [ `uci get voip.$client.ext_type` == "analog" ]; then
			ANALOG_NUMBER=`uci get voip.$client.number`
		fi
	fi
		
	# remove blank user
	if [ -z `uci get voip.$client.number` ]; then
		uci delete voip.$client
	fi
done

uci commit voip


SIP_CLIENT_INFO=`cat $TMP_SIP_CLIENT`
IAX2_CLIENT_INFO=`cat $TMP_IAX2_CLIENT`

# Create 'softphone.sip.conf' include file
# Everything from here to EOF will be written to the file

cat > /etc/asterisk/softphone.sip.conf << EOF
;----------------------------------------------
; /etc/asterisk/softphone.sip.conf
; ---------------------------------------------

; softphone users
; CAUTION: This is an automatically generated file by script /etc/init.d/config2asterisk
; Do not edit this file manually on a running system
; See /etc/config/voip for config parameters

[softph](!)
; Template of settings
type=friend
context=incoming-softphone
host=dynamic
allow=alaw,ulaw,gsm
dtmfmode=rfc2833
qualify=yes
canreinvite=nonat
alwaysauthreject=yes
mailbox=null

$SIP_CLIENT_INFO

EOF
# ------------------------------------------------------------------


# Create 'softphone.iax2.conf' include file
# Everything from here to EOF will be written to the file

cat > /etc/asterisk/softphone.iax2.conf << EOF
;----------------------------------------------
; /etc/asterisk/softphone.iax2.conf
; ---------------------------------------------

; softphone users
; CAUTION: This is an automatically generated file by script /etc/init.d/config2asterisk
; Do not edit this file manually on a running system
; See /etc/config/voip for config parameters

[softph](!)
; Template of settings
type=friend
context=incoming-softphone
host=dynamic
allow=all


$IAX2_CLIENT_INFO

EOF
# ------------------------------------------------------------------

